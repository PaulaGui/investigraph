<!doctype html>
<meta charset="utf-8">
<title>net graph</title>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.min.css">
<style>
.node circle {
  stroke: #fff;
  stroke-width: 1.5px;
  fill: steelblue;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}
</style>

<body>

<p>
  Graph of investigative journalists, stories, organizations. Source code and
  data: <a
  href="https://github.com/mgax/investigraph">github.com/mgax/investigraph</a>,
  based on the d3.js <a href="http://bl.ocks.org/mbostock/4062045">force
  graph</a> example.
</p>

<script src="//cdnjs.cloudflare.com/ajax/libs/js-yaml/3.2.7/js-yaml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>

<script type="text/babel">
fetch('graph.yaml').then((res) => {
  res.text().then((text) => {
    let data = jsyaml.load(text)
    let width = 960
    let height = 500

    let svg = d3.select('body').append('svg')
        .attr('width', width)
        .attr('height', height)

    let force = null

    function render(graph) {
      if(force) { force.stop() }

      force = d3.layout.force()
          .charge(-300)
          .linkDistance(50)
          .linkStrength(.2)
          .size([width, height])

      force
          .nodes(graph.nodes)
          .links(graph.links)
          .start()

      for(var i = 0; i < 500; ++i) { force.tick() }
      force.stop()

      let link = svg.selectAll('.link')
          .data(graph.links)
        .enter().append('line')
          .attr('class', 'link')
          .style('stroke-width', (d) => Math.sqrt(d.value))

      let node = svg.selectAll('.node')
          .data(graph.nodes)
        .enter().append('g')
          .attr('class', 'node')

      node.append('circle')
          .attr('r', 5)

      node.append('title')
          .text((d) => JSON.stringify(d))

      link.attr('x1', (d) => d.source.x)
          .attr('y1', (d) => d.source.y)
          .attr('x2', (d) => d.target.x)
          .attr('y2', (d) => d.target.y)

      node.attr('transform', (d) => `translate(${d.x},${d.y})`)
    }

    let entityMap = {}
    let nodes = []
    Object.keys(data.entities).forEach((key, idx) => {
      let entity = data.entities[key]
      nodes.push(entity)
      entityMap[key] = idx
    })
    let links = []
    for(let l of data.links) {
      let link = {
        source: entityMap[l.source],
        target: entityMap[l.target],
      }
      if(link.source !== undefined && link.target !== undefined) {
        links.push(link)
      }
    }

    render({nodes: nodes, links: links})
  })
})
</script>
